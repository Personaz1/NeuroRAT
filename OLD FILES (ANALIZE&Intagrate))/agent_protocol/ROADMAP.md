# План разработки системы агентской коммуникации

## Этап 1: Базовая инфраструктура ✅
- Проектирование протокола обмена сообщениями ✅
- Разработка системы шифрования (AES-256) ✅
- Создание базовых классов Command и Response ✅
- Реализация механизма сериализации/десериализации сообщений ✅

## Этап 2: Серверная часть ✅
- Разработка фонового сервиса для Ubuntu ✅
- Имплементация обработчиков команд (shell, file, llm) ✅
- Создание системы логирования ✅
- Разработка механизма создания демона ✅
- Интеграция с systemd для автозапуска ✅

## Этап 3: Клиентская часть ✅
- Разработка клиентского API ✅
- Создание механизма подключения к серверу ✅
- Реализация интерфейса командной строки ✅
- Добавление поддержки различных типов команд ✅

## Этап 4: Безопасность и администрирование ✅
- Реализация шифрования на уровне сообщений ✅
- Добавление опциональной поддержки SSL ✅
- Создание инсталляционного скрипта ✅
- Разработка средств мониторинга и управления ✅

## Этап 5: Улучшения (В процессе)
- Реализация обмена ключами по алгоритму Диффи-Хеллмана ✅
  - Базовая реализация в key_exchange.py ✅
  - Интеграция с EnhancedSecureChannel ✅
  - Валидация ключей для защиты от MITM-атак ✅
  - Тестовый скрипт для проверки работы ✅
- Внедрение DNS-туннелирования для скрытой коммуникации (Высокий приоритет)
  - Реализация шифрованной передачи команд через DNS-запросы
  - Создание модуля DNS Resolver с сегментацией данных (63 байта)
  - Компрессия и шифрование полезной нагрузки
  - Имитация легитимного DNS-трафика
- Добавление аутентификации на основе сертификатов
- Создание плагина для популярных IDE
- Расширение API для поддержки новых типов команд
- Оптимизация производительности при передаче больших файлов

## Этап 6: Продвинутые техники безопасности (Высокий приоритет)
- Техники обхода AMSI и ETW для Windows-агентов
  - Патчинг AmsiScanBuffer в памяти
  - Отключение ETW для защиты от логирования
  - Прямое использование syscalls в обход User-Mode Hooks
- HTTPS с TLS обфускацией
  - Эмуляция легитимного браузерного трафика
  - Скрытие командного трафика в cookie и заголовках
  - Динамическая генерация параметров запросов
- Техники маскировки процесса
  - Модификация PEB для сокрытия от задиспетчера процессов
  - Parent Process ID Spoofing
  - Process Hollowing с полной заменой образа
- Полиморфная кодовая база
  - Динамически модифицируемый код
  - Обфускация строк и функций
  - Модификация потока исполнения

## Этап 7: Масштабирование и автономность (Запланировано)
- Поддержка кластера серверов
- Реализация механизма балансировки нагрузки
- Создание центрального сервера управления агентами
- Разработка панели администрирования
- Добавление метрик и аналитики использования
- Динамическое шифрование в памяти
  - Защита чувствительных данных от дампинга памяти
  - Расшифровка только перед использованием
  - Изоляция ключевых компонентов в памяти
- DLL Unhooking для защиты от мониторинга
  - Восстановление оригинальных байтов из чистой копии DLL
  - Защита от инъекций EDR-решений

## Этап 8: NeuroRAT - LLM-управляемый агент (В процессе)
- Интеграция с локальными LLM (Ollama, llama.cpp) ✅
- Методы обхода антивирусной защиты ✅
- Автономное принятие решений на базе LLM ✅
- Продвинутая персистентность и обход защиты:
  - COM Hijacking для незаметного автозапуска
  - WMI Event Subscription для персистентности
  - AppInit_DLLs для внедрения в процессы
- Динамическое расшифрование и выполнение кода
  - Шифрование полезной нагрузки с ключом, зависящим от контекста системы
  - Расшифровка и выполнение непосредственно в памяти
- Модуль самоадаптации и обучения
- Обход поведенческого анализа
  - Проверки на эмуляцию и "песочницы"
  - Адаптивное поведение в зависимости от среды
- Динамическое изменение стратегии в зависимости от среды
- Многоуровневая персистентность
- Техники поиска целевых данных с помощью LLM
- Обфускация коммуникации и модификация протокола
- Создание распределенной сети агентов
- Внедрение техник обхода EDR/XDR решений
- Интеграция с моделью машинного обучения для обнаружения ценных данных

## Этап 9: Продвинутые техники внедрения (Средний приоритет)
- Thread Execution Hijacking
  - Приостановка существующего потока
  - Модификация контекста потока
  - Перенаправление исполнения
- Рефлективная загрузка DLL
  - Инъекция без использования LoadLibrary
  - Самостоятельное разрешение импортов
  - Перемещение и инициализация в памяти
- Защита от анализа памяти
  - Политики защиты от дампирования памяти
  - Предотвращение инъекций в protected-процессы
- Техники обхода статического анализа
  - Динамическая генерация имен функций
  - Обфускация импортов через importlib
  - Разделение кода на некоррелирующие фрагменты

## Этап 10: Дополнительные функции (Низкий приоритет)
- Интеграция с существующими CI/CD системами
- Поддержка WebSocket для работы через веб-интерфейс
- Создание маркетплейса команд и сценариев
- Разработка системы плагинов для расширения функциональности
- Имплементация многопользовательского режима с разграничением прав
- Исследование квантово-защищенных протоколов
  - Подготовка к пост-квантовой криптографии
  - Внедрение алгоритмов, устойчивых к квантовым атакам
  - Изучение квантовой запутанности для безопасной коммуникации

## Детальное поведение серверного агента

### 1. Инициализация (startup)
- Запуск как демон или сервис (systemd, init.d, nohup, supervisord)
- Проверка на уже запущенные экземпляры (через lock-файл или PID)
- Генерация уникального ID агента (если не был сгенерирован ранее)
- Загрузка конфигурации: ключи, параметры связи, ограничения
- Шифрованный handshake с сервером (ключ AES через обмен RSA или Diffie-Hellman)
- Самостоятельная "регистрация" на первом запуске
- Проверка окружения на признаки анализа (эмуляторы, отладчики, песочницы)

### 2. Основной цикл (loop)
- Регулярное соединение с сервером (или прием входящих при работе как listener)
- Отправка heartbeat/ping с ID, временем, версией, мета-информацией
- Прием зашифрованной команды
- Расшифровка, проверка целостности и валидности подписи
- Выполнение команды с использованием:
  - Подмодулей (exec, file, llm, monitor и др.)
  - Изоляции, если требуется (chroot, subprocess, jail)
- Сбор результата, шифрование, отправка серверу
- Поддержка разных уровней приоритета (срочные, фоновые, отложенные задачи)

### 3. Поведение при ошибках/отсутствии связи
- Переход в оффлайн-режим при отсутствии связи с сервером:
  - Запись команд в очередь
  - Периодические попытки переподключения
  - Автоматическое переключение на альтернативные каналы связи (DNS, HTTPS, ICMP)
- Инициация повторного handshake при истечении/повреждении ключа шифрования
- Логирование критических ошибок и самоперезапуск
- Отправка уведомлений через альтернативные каналы (резервный адрес, webhook)

### 4. Поддерживаемые команды (payloads)
| Команда | Назначение |
|---------|------------|
| exec | Выполнить shell-команду |
| read_file | Прочитать содержимое файла |
| write_file | Записать/создать файл |
| list_dir | Просмотр содержимого директории |
| query_llm | Отправка запроса в локальный LLM |
| upload | Отправка файла серверу |
| download | Получение файла с сервера |
| sysinfo | Информация о CPU, RAM, uptime |
| ping | Проверка соединения |
| self_update | Обновление бинарника или модулей |
| self_destruct | Самоудаление агента |
| memory_protect | Защита сегментов памяти от чтения |
| dns_tunnel | Переключение на DNS-канал связи |
| unhook_dll | Восстановление оригинальных байтов DLL |
| disable_protection | Отключение мониторинга (AMSI, ETW) |
| inject_process | Внедрение кода в целевой процесс |
| cloak_process | Маскировка идентификаторов процесса |

### 5. Устойчивость (persistence)
- Регистрация как systemd-сервис с автостартом и перезапуском
- Самоконтроль: перезапуск при неактивности N минут
- Опциональная обфускация имени процесса
- Шифрование логов и файлов конфигурации
- Многоуровневые механизмы персистентности:
  - WMI Event Subscription
  - COM Hijacking
  - AppInit_DLLs (Windows)
  - Cron/Systemd Timer (Linux)
  - Launch Agent/Daemon (macOS)

### 6. Безопасность
- AES-256 шифрование всех сообщений (GCM или CBC + HMAC)
- RSA-2048 для установки ключа при первом handshake
- Хеширование команд для проверки целостности
- Валидация токена/подписи сервера для недоверенных сетей
- Опциональный запрет команд от неизвестных IP
- Обфускация строк в памяти
- Динамическое шифрование чувствительных участков памяти
- Защита от дампинга памяти

### 7. Особенности LLM-доступа
- Локальное обращение к LLM API (через localhost:11434 или unix socket)
- Передача текста от сервера в LLM и возврат ответа
- Кэширование результатов для снижения нагрузки
- Использование LLM для:
  - Анализа обнаруженных данных
  - Принятия решений по автоматизации задач
  - Обхода защитных механизмов
  - Генерации полиморфного кода

### 8. Поведение при обновлении
- Проверка наличия новой версии (по контрольной сумме или версии)
- Загрузка обновленного бинарника/скрипта
- Проверка цифровой подписи
- Самозамена (горячая замена или перезапуск)
- Сообщение серверу об успешном обновлении

### 9. Логирование и отладка
- Запись зашифрованных логов в ~/.agent/logs/agent.log
- Передача лога серверу по команде
- Поддержка уровней логирования: DEBUG/INFO/ERROR
- Отдельный лог по выполненным командам
- Предотвращение логирования критических операций

### Дополнительно (на перспективу)
- Веб-интерфейс или TUI на сервере для мониторинга агентов
- Автогенерация токенов/ключей при развертывании
- Интеграция с Telegram/Discord для срочных уведомлений
- Кросс-платформенность (Linux, Mac, Windows)
- Автономное принятие решений при изоляции от сервера

## График релизов

| Версия | Дата      | Основные функции                                   |
|--------|-----------|---------------------------------------------------|
| 0.1.0  | Выполнено | Базовая коммуникация, шифрование                  |
| 0.2.0  | Выполнено | Полнофункциональный сервер и клиент               |
| 0.3.0  | Выполнено | Улучшенная безопасность, улучшения производительности |
| 0.4.0  | Выполнено | LLM-интеграция, базовая автономность              |
| 1.0.0  | Q2 2024   | DNS-туннелирование, продвинутая маскировка        |
| 1.1.0  | Q3 2024   | Техники обхода AMSI, ETW и полиморфная кодовая база |
| 1.2.0  | Q4 2024   | Продвинутое внедрение кода и обход EDR-защиты     |
| 2.0.0  | Q1 2025   | Полноценная экосистема с маркетплейсом, продвинутая защита от анализа |

## Приоритеты развития

### Высокий приоритет
- Безопасность и шифрование
- DNS-туннелирование и скрытая коммуникация
- Техники обхода EDR и AMSI
- Продвинутая персистентность
- Полиморфная кодовая база

### Средний приоритет
- Динамическое шифрование памяти
- Process Hollowing и техники внедрения кода
- Интеграция с популярными IDE
- Документация и примеры использования
- Производительность при передаче больших объемов данных

### Низкий приоритет
- Графический интерфейс администрирования
- Маркетплейс расширений
- Нативные клиенты для мобильных устройств
- Пост-квантовая криптография 